<section class="page" aria-labelledby="trade-title">
  <div class="header" style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
    <h1 id="trade-title" style="margin:0;display:flex;align-items:center;gap:10px;">
      Trade <span style="opacity:.8">#${TID}</span>
    </h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn" id="copySymbolBtn" type="button" title="Copy symbol">${SYMBOL} ⧉</button>
      <button class="btn" id="exportCsvBtn" type="button" title="Export executions CSV">Export CSV</button>
      <a class="btn" href="/trades">← All Trades</a>
    </div>
  </div>

  <!-- Summary -->
  <div class="card" style="margin-bottom:16px;">
    <div class="panel-title" style="margin-bottom:10px;">Summary</div>
    <div style="display:grid;grid-template-columns: repeat(8, minmax(0,1fr));gap:12px;">
      <div>
        <div class="kpi-label">Symbol</div>
        <div class="kpi-value" style="font-size:18px;display:flex;align-items:center;gap:8px;">
          ${SYMBOL}
          <span class="badge" style="font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;opacity:.8;">${ACCOUNT}</span>
        </div>
      </div>
      <div>
        <div class="kpi-label">Side</div>
        <div class="kpi-value" style="font-size:18px;">
          <span style="padding:2px 8px;border-radius:999px;border:1px solid var(--border);" class="${SIDE_CLASS}">${SIDE}</span>
        </div>
      </div>
      <div><div class="kpi-label">Volume</div><div class="kpi-value" style="font-size:18px;">${VOL}</div></div>
      <div>
        <div class="kpi-label">Status</div>
        <div class="kpi-value" style="font-size:18px;">
          <span style="padding:2px 8px;border-radius:999px;border:1px solid var(--border);" class="${STATUS_CLASS}">${STATUS}</span>
        </div>
      </div>
      <div><div class="kpi-label">Open</div><div class="kpi-value" style="font-size:16px;font-weight:600;">${OPEN}</div></div>
      <div><div class="kpi-label">Close</div><div class="kpi-value" style="font-size:16px;font-weight:600;">${CLOSE}</div></div>
      <div><div class="kpi-label">Fees</div><div class="kpi-value" style="font-size:18px;">${FEES}</div></div>
      <div><div class="kpi-label">P/L</div><div class="kpi-value ${PNL_CLASS}" style="font-size:22px;font-weight:700;">${PNL}</div></div>
    </div>
  </div>

  <!-- Chart -->
  <div class="card" style="margin-bottom:16px;">
    <div class="panel-title" style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
      <span>Price Chart (1m)</span>
      <div style="font-size:12px;opacity:.8;">${SYMBOL} • full day</div>
    </div>

    <div id="tv-wrap" style="height:520px;position:relative;">
      <div id="tv-chart" style="position:absolute;inset:0;"></div>
      <div id="tv-empty" style="display:none;position:absolute;inset:0;align-items:center;justify-content:center;opacity:.7;">
        <div>No intraday candles available.</div>
      </div>
    </div>

    <!-- Executions JSON + context for JS -->
    <script id="trade-execs"
            type="application/json"
            data-symbol="${SYMBOL}"
            data-trade-date="${TRADE_DATE_YYYYMMDD}">
      ${EXECS_JSON}
    </script>
  </div>

  <!-- Executions table -->
  <div class="card">
    <div class="panel-title" style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
      <span>Executions</span>
      <div style="font-size:12px;opacity:.8;">${EX_COUNT} fills</div>
    </div>

    <div class="table-wrap" style="--sticky-top: 0;">
      <table class="table-wide" id="execTable">
        <thead style="position:sticky;top:var(--sticky-top);z-index:1;">
          <tr>
            <th style="text-align:left;white-space:nowrap;">Date/Time</th>
            <th style="text-align:left;">Symbol</th>
            <th style="text-align:left;">Side</th>
            <th class="num">Qty</th>
            <th class="num">Price</th>
            <th class="num">Fees</th>
            <th class="num">P/L (Cum.)</th>
            <th class="num">Position After</th>
            <th style="text-align:left;">Account</th>
            <th style="text-align:left;">Exchange</th>
          </tr>
        </thead>
        <tbody>
          ${EX_ROWS}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Chart + UI logic -->
<script>
(async function () {
  // ----- Quick UI helpers -----
  var copyBtn = document.getElementById('copySymbolBtn');
  if (copyBtn) {
    copyBtn.addEventListener('click', function () {
      try {
        var txt = this.textContent.replace('⧉','').trim();
        navigator.clipboard.writeText(txt);
        this.textContent = 'Copied!';
        setTimeout(() => this.textContent = txt + ' ⧉', 900);
      } catch (e) {}
    });
  }

  var exportBtn = document.getElementById('exportCsvBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', function () {
      var table = document.getElementById('execTable');
      if (!table) return;
      var rows = Array.from(table.querySelectorAll('tr'));
      var csv = rows.map(function (tr) {
        return Array.from(tr.children).map(function (td) {
          var t = (td.innerText || '').replaceAll('"','""').trim();
          return '"' + t + '"';
        }).join(',');
      }).join('\\r\\n');
      var blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'trade_' + '${TID}' + '_executions.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  }

  // ----- Elements & data -----
  const wrap  = document.getElementById('tv-wrap');
  const el    = document.getElementById('tv-chart');
  const empty = document.getElementById('tv-empty');
  const holder = document.getElementById('trade-execs');
  if (!wrap || !el || !holder) return;

  const SYMBOL    = holder.dataset.symbol;
  const TRADE_YMD = holder.dataset.tradeDate;

  let EXECS = [];
  try { EXECS = JSON.parse((holder.textContent || '').trim() || '[]'); } catch (_) {}

  // Normalize exec times and snap to 1m bar
  const toUnix = t => Math.floor(new Date(t).getTime() / 1000);
  const snapMinute = (s) => Math.floor(Number(s) / 60) * 60;

  let sorted = (EXECS || []).map(ex => ({
    ...ex,
    _epoch: (typeof ex.ts === 'number' && isFinite(ex.ts)) ? ex.ts : toUnix(ex.time)
  })).sort((a, b) => a._epoch - b._epoch);

  // After candles load, compute _bar for each exec
  let candleTimes = [];
  function bindExecsToBars(candles) {
    candleTimes = candles.map(c => Number(c.time));
    function nearestBarTime(t) {
      const snapped = snapMinute(t);
      if (candleTimes.indexOf(snapped) !== -1) return snapped;
      let best = candleTimes[0], bestDiff = Math.abs(snapped - candleTimes[0]);
      for (let i = 1; i < candleTimes.length; i++) {
        const d = Math.abs(snapped - candleTimes[i]);
        if (d < bestDiff) { best = candleTimes[i]; bestDiff = d; }
        else if (candleTimes[i] > snapped && d > bestDiff) break;
      }
      return best;
    }
    sorted = sorted.map(ex => ({ ...ex, _bar: nearestBarTime(ex._epoch) }));
  }

  // ----- Load Lightweight-Charts -----
  try { delete window.LightweightCharts; } catch (_) { window.LightweightCharts = undefined; }
  function loadLWC(src) {
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = resolve; s.onerror = () => reject(new Error('Failed to load ' + src));
      document.head.appendChild(s);
    });
  }
  await loadLWC('https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js');
  if (!window.LightweightCharts || typeof LightweightCharts.createChart !== 'function') {
    empty.style.display = 'flex'; return;
  }
  const LWC = window.LightweightCharts;

  // ----- Fetch minute candles for the trade day -----
  const qs = new URLSearchParams({ symbol: SYMBOL });
  if (TRADE_YMD) qs.set('date', TRADE_YMD);

  let candles = [];
  try {
    const r = await fetch('/api/candles?' + qs.toString(), { cache: 'no-store' });
    const j = await r.json();
    candles = j.candles || [];
    bindExecsToBars(candles);
  } catch (e) {}

  if (!candles.length) { empty.style.display = 'flex'; return; }

  // ----- Build chart -----
  const size = () => ({ width: wrap.clientWidth || 800, height: wrap.clientHeight || 520 });

  const isLight = document.documentElement.classList.contains('light') || document.body.classList.contains('light');
  const textColor = isLight ? '#334155' : '#cbd5e1';

  const lwcChart = LWC.createChart(el, {
    ...size(),
    layout: { background: { color: 'transparent' }, textColor: textColor },
    rightPriceScale: { borderColor: 'rgba(255,255,255,.10)' },
    timeScale: { borderColor: 'rgba(255,255,255,.10)', timeVisible: true, secondsVisible: false },
    grid: { vertLines: { color: 'rgba(255,255,255,.06)' }, horzLines: { color: 'rgba(255,255,255,.06)' } },
    crosshair: { mode: LWC.CrosshairMode.Normal },
  });

  // ----- Show New York time on x-axis -----
  const TZ_NY = 'America/New_York';
  lwcChart.timeScale().applyOptions({
    tickMarkFormatter: (time) => {
      const d = new Date(Number(time) * 1000);
      return new Intl.DateTimeFormat('en-US', { timeZone: TZ_NY, hour: '2-digit', minute: '2-digit' }).format(d);
    }
  });

  // Candles
  const candleSeries = lwcChart.addCandlestickSeries({
    upColor: '#26a69a',
    downColor: '#ef5350',
    borderVisible: false,
    wickUpColor: '#26a69a',
    wickDownColor: '#ef5350',
  });
  candleSeries.setData(candles.map(c => ({ time: c.time, open: c.open, high: c.high, low: c.low, close: c.close })));

  // ---------------- Premarket levels (04:00–09:30 ET) ----------------
  function nyParts(ts){
    const d = new Date(Number(ts) * 1000);
    const fmt = new Intl.DateTimeFormat('en-US', {
      timeZone: TZ_NY, year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
    });
    const p = Object.fromEntries(fmt.formatToParts(d).map(o => [o.type, o.value]));
    return { ymd: `${p.year}-${p.month}-${p.day}`, hh:+p.hour, mm:+p.minute, ss:+p.second };
  }

  // Resolve trade date in NY time
  const tradeYMD_ET = (TRADE_YMD && TRADE_YMD.length === 8)
    ? `${TRADE_YMD.slice(0,4)}-${TRADE_YMD.slice(4,6)}-${TRADE_YMD.slice(6,8)}`
    : nyParts(candles[0].time).ymd;

  const dayCandles = candles.filter(c => nyParts(c.time).ymd === tradeYMD_ET);

  // premarket filter: >= 04:00:00 and < 09:30:00 ET
  const pmCandles = dayCandles.filter(c => {
    const t = nyParts(c.time);
    const after400 = (t.hh > 4) || (t.hh === 4);                     // >= 04:00
    const before930 = (t.hh < 9) || (t.hh === 9 && t.mm < 30);       // < 09:30
    return after400 && before930;
  });

  if (pmCandles.length) {
    const pmHigh = Math.max(...pmCandles.map(c => Number(c.high)));
    const pmLow  = Math.min(...pmCandles.map(c => Number(c.low)));

    const dotted = LWC.LineStyle.Dotted;
    const blue   = '#60a5fa'; // Tailwind-ish sky-400

    candleSeries.createPriceLine({
      price: pmHigh,
      color: blue,
      lineWidth: 2,
      lineStyle: dotted,
      axisLabelVisible: true,
      title: 'PM High'
    });

    candleSeries.createPriceLine({
      price: pmLow,
      color: blue,
      lineWidth: 2,
      lineStyle: dotted,
      axisLabelVisible: true,
      title: 'PM Low'
    });
  }

  // ---------------- Volume (confined bottom band) ----------------
  const volSeries = lwcChart.addHistogramSeries({
    priceScaleId: 'volume',
    priceFormat: { type: 'volume' },
    overlay: true
  });
  volSeries.priceScale().applyOptions({
    visible: false,
    scaleMargins: { top: 0.96, bottom: 0.00 }
  });

  const vols = candles.map(c => Number(c.volume) || 0).sort((a,b) => a - b);
  const cap = vols[Math.floor((vols.length - 1) * 0.98)] || 1;

  volSeries.setData(candles.map(c => ({
    time: c.time,
    value: Math.min(Number(c.volume) || 0, cap),
    color: (c.close >= c.open) ? '#26a69a' : '#ef5350'
  })));
  volSeries.applyOptions({
    autoscaleInfoProvider: () => ({ priceRange: { minValue: 0, maxValue: cap } })
  });

  // ---------------- Accurate execution overlay (no text) ----------------
  const overlay = document.createElement('div');
  overlay.className = 'exec-overlay';
  overlay.style.position = 'absolute';
  overlay.style.inset = '0';
  overlay.style.pointerEvents = 'none';
  el.appendChild(overlay);

  const execs = sorted.map((ex, i) => {
    const isBuy  = /^(buy|bot|long)$/i.test(ex.side || '');
    const isEntry = i === 0;
    const isExit  = i === sorted.length - 1;
    const isPartial = !isEntry && !isExit;
    return {
      time: Number(ex._bar),
      price: Number(ex.price),
      isBuy, isEntry, isExit, isPartial
    };
  });

  function xAt(time)  { return lwcChart.timeScale().timeToCoordinate(time); }
  function yAt(price) { return candleSeries.priceToCoordinate(price); }

  function renderExecs() {
    overlay.innerHTML = '';
    const rect = el.getBoundingClientRect();
    const pad = 2;

    for (const ex of execs) {
      const x = xAt(ex.time);
      const y = yAt(ex.price);
      if (x == null || y == null) continue;

      const left = Math.max(pad, Math.min(rect.width  - pad, Math.round(x)));
      const top  = Math.max(pad, Math.min(rect.height - pad, Math.round(y)));

      const tri = document.createElement('div');
      tri.className = 'exec-tri ' + (ex.isBuy ? 'buy' : 'sell') + (ex.isPartial ? ' partial' : ' full');
      tri.style.left = left + 'px';
      tri.style.top  = top  + 'px';
      overlay.appendChild(tri);
    }
  }

  renderExecs();
  new ResizeObserver(renderExecs).observe(wrap);
  lwcChart.timeScale().subscribeVisibleTimeRangeChange(renderExecs);
  candleSeries.priceScale().subscribeVisiblePriceRangeChange(renderExecs);

  lwcChart.timeScale().fitContent();
})();
</script>

<style>
.badge { display:inline-block; }
.kpi-label { opacity:.7; font-size:12px; margin-bottom:2px; }
.kpi-value { font-weight:600; }

.table-wide tbody tr:nth-child(odd){ background: color-mix(in oklab, var(--card), transparent 70%); }
.table-wide th, .table-wide td { vertical-align:middle; }

/* ---------- Execution overlay ---------- */
.exec-overlay{position:absolute;inset:0;pointer-events:none}
.exec-tri{position:absolute;width:0;height:0;transform:translate(-50%,-50%)}

/* Entry/Exit = larger; Partial = smaller/softer */
.exec-tri.full.buy {
  border-top: 7px solid transparent;
  border-bottom: 7px solid transparent;
  border-left: 12px solid #26a69a;   /* green */
}
.exec-tri.full.sell {
  border-top: 7px solid transparent;
  border-bottom: 7px solid transparent;
  border-right: 12px solid #ef5350;  /* red */
}
.exec-tri.partial.buy {
  border-top: 5px solid transparent;
  border-bottom: 5px solid transparent;
  border-left: 8px solid #9dddc8;    /* softer green */
}
.exec-tri.partial.sell {
  border-top: 5px solid transparent;
  border-bottom: 5px solid transparent;
  border-right: 8px solid #f3a3a3;   /* softer red */
}
</style>
