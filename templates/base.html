<!doctype html>

<html lang="en">
  <!-- Apply saved theme BEFORE paint -->
  <script>
    (function () {
      var theme = localStorage.getItem('theme') || 'dark';
      if (theme === 'light') {
        document.documentElement.classList.add('light');
      } else {
        document.documentElement.classList.remove('light');
      }
    })();
  </script>
  <script>
  /* Apply persisted UI state BEFORE first paint */
  (function () {
    try {
      // Theme
      var theme = localStorage.getItem('theme') || localStorage.getItem('preferred-theme') || 'dark';
      if (theme === 'light') document.documentElement.classList.add('light');

      // Sidebar collapsed (use html element so it's available before <body>)
      if (localStorage.getItem('sidebar-collapsed') === '1') {
        document.documentElement.classList.add('sidebar-collapsed');
      }
    } catch (e) {}
  })();
  </script>
  <link rel="stylesheet" href="/static/style.css">

  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>TradeJournal Portal</title>

    <!-- Styles -->
    <link rel="stylesheet" href="/static/style.css">

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <script>
      // Single source of truth for theme
      function setTheme(theme) {
        localStorage.setItem('theme', theme);

        // Apply to <html> immediately (CSS vars resolve from here)
        var isLight = theme === 'light';
        document.documentElement.classList.toggle('light', isLight);

        // Keep <body> in sync
        document.body.classList.toggle('light', isLight);

        // Update menu active states if present
        document.querySelectorAll('.theme-option').forEach(function (el) {
          var label = el.textContent.toLowerCase().trim();
          el.classList.toggle('active', label === theme);
        });
      }

      // Early init (no-flash helpers, sidebar state)
      (function () {
        // Optional debug outlines via ?debug=1
        try {
          if (location.search.indexOf('debug=1') !== -1) {
            document.addEventListener('DOMContentLoaded', function () {
              document.body.classList.add('debug-outline');
            });
          }
        } catch (e) {}

        // Restore sidebar collapsed
        var sc = localStorage.getItem('sidebar-collapsed');
        if (sc === '1') {
          document.addEventListener('DOMContentLoaded', function () {
            document.body.classList.add('sidebar-collapsed');
          });
        }
      })();
    </script>
  </head>

  <script>
  (function () {
    const DURATION = 160; // ms – fast and crisp

    // ----- ENTER: fade in after the DOM is ready -----
    function runEnter() {
      document.body.classList.add('page-enter');
      // two rafs to ensure styles apply before toggling active state
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          document.body.classList.add('page-enter-active');
          setTimeout(() => {
            document.body.classList.remove('page-enter', 'page-enter-active');
          }, DURATION);
        });
      });
    }

    // ----- LEAVE: fade out before navigating -----
    function leaveTo(url) {
      document.body.classList.add('page-leave');
      setTimeout(() => { window.location.href = url; }, DURATION);
    }

    // Intercept same-origin internal links (no modifiers, no targets)
    function shouldIntercept(a) {
      if (!a) return false;
      if (a.target && a.target !== '_self') return false;
      const url = new URL(a.href, window.location.href);
      if (url.origin !== window.location.origin) return false; // external
      if (url.href === window.location.href) return false;     // same page
      // don’t intercept downloads or anchors that rely on default behavior
      if (a.hasAttribute('download')) return false;
      if (url.hash && url.pathname === window.location.pathname) return false;
      return true;
    }

    function onClick(e) {
      if (e.defaultPrevented) return;
      // ignore modified clicks (new tab/window)
      if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

      const a = e.target.closest('a[href]');
      if (!a || !shouldIntercept(a)) return;

      e.preventDefault();
      leaveTo(a.href);
    }

    // Run animations
    document.addEventListener('DOMContentLoaded', runEnter);
    document.addEventListener('click', onClick);

    // Make back/forward cache restores also fade-in cleanly
    window.addEventListener('pageshow', function (evt) {
      if (evt.persisted) runEnter();
    }, false);
  })();
  </script>
  <script>
  (function () {
    const DUR = 160; // fast + clean

    function beginEnter() {
      document.body.classList.add('page-anim', 'page-enter');
      // two rafs to ensure initial styles apply
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          document.body.classList.add('page-enter-active');
          setTimeout(() => {
            document.body.classList.remove('page-enter', 'page-enter-active', 'page-anim');
          }, DUR);
        });
      });
    }

    function leaveTo(url) {
      document.body.classList.add('page-anim', 'page-leave');
      setTimeout(() => { window.location.href = url; }, DUR);
    }

    function sameOrigin(href) {
      try { return new URL(href, location.href).origin === location.origin; }
      catch { return false; }
    }

    function onClick(e) {
      if (e.defaultPrevented) return;
      if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

      const a = e.target.closest('a[href]');
      if (!a) return;

      // skip external, same-page anchors, new windows, downloads
      if (!sameOrigin(a.href)) return;
      if (a.target && a.target !== '_self') return;
      const u = new URL(a.href, location.href);
      if (u.href === location.href) return;
      if (a.hasAttribute('download')) return;
      if (u.hash && u.pathname === location.pathname) return;

      e.preventDefault();
      leaveTo(a.href);
    }

    document.addEventListener('DOMContentLoaded', beginEnter);
    document.addEventListener('click', onClick);
    window.addEventListener('pageshow', (e) => { if (e.persisted) beginEnter(); }, false);
  })();
  </script>

  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="logo">Trade<span>Journal</span></div>
        <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar">◀</button>

        <nav>
          <a href="/dashboard" class="active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            <span>Dashboard</span>
          </a>
          <a href="/calendar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span>Calendar</span>
          </a>
          <a href="/trades">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20V10"></path>
              <path d="M18 20V4"></path>
              <path d="M6 20v-4"></path>
            </svg>
            <span>Trades</span>
          </a>
          <a href="/reports">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6z"></path>
              <path d="M14 3v5h5M16 13H8M16 17H8M10 9H8"></path>
            </svg>
            <span>Reports</span>
          </a>
          <a href="/journal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h15a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H4V4z"></path>
              <line x1="8" y1="4" x2="8" y2="20"></line>
            </svg>
            <span>Journal</span>
          </a>
          <a class="upload" href="/upload">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <span>Import Trades</span>
          </a>
        </nav>

        <div class="settings-bar" tabindex="0">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          Settings

          <div class="settings-menu">
            <h3>Appearance</h3>
            <div class="theme-options">
              <div class="theme-option" data-theme="dark">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
                Dark
              </div>
              <div class="theme-option" data-theme="light">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="5"></circle>
                  <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                </svg>
                Light
              </div>
            </div>
          </div>
        </div>
      </aside>

      <main class="main">
        ${CONTENT}
      </main>
    </div>

    <!-- ONE script block to wire interactions -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Keep body in sync with <html> class applied pre-paint
        var theme = localStorage.getItem('theme') || 'dark';
        document.body.classList.toggle('light', theme === 'light');

        // Mark active option
        document.querySelectorAll('.theme-option').forEach(function (el) {
          var label = el.textContent.toLowerCase().trim();
          el.classList.toggle('active', label === theme);
        });

        // Handle theme clicks (using data-theme)
        document.querySelectorAll('.theme-option').forEach(function (el) {
          el.addEventListener('click', function () {
            var mode = el.getAttribute('data-theme');
            setTheme(mode);
          });
        });

        // Sidebar toggle persistence
        var btn = document.getElementById('sidebarToggle');
        if (btn) {
          btn.addEventListener('click', function () {
            document.body.classList.toggle('sidebar-collapsed');
            var collapsed = document.body.classList.contains('sidebar-collapsed') ? '1' : '0';
            localStorage.setItem('sidebar-collapsed', collapsed);
          });
        }

        // Plotly helper cleanup (defensive)
        function removePlotlyHelperElements() {
          try {
            var candidates = Array.from(document.querySelectorAll('svg[id^="js-plotly"], svg[id*="plotly-tester"], svg[id^="plotly"]'));
            candidates.forEach(function (el) {
              try {
                var r = el.getBoundingClientRect();
                if (r.width > 2000 || r.height > 2000 || Math.abs(r.x) > 5000 || Math.abs(r.y) > 5000) {
                  el.remove();
                }
              } catch (e) {}
            });
          } catch (e) {}
        }
        removePlotlyHelperElements();
        var _pCount = 0, _pInt = setInterval(function () {
          removePlotlyHelperElements();
          _pCount++;
          if (_pCount > 6) clearInterval(_pInt);
        }, 700);
      });
    </script>
  </body>
</html>
